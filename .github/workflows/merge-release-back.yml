# When a new push happens to a release-N branch,
# create a pull request merging the latest commit back to the `develop` branch.

---

on:
  push:
    branches: ['release-[0-9]+']

jobs:
  build:
    runs-on: ubuntu-latest
    # this job should only run for things added after the branch is initially created
    if: "contains(github.event.created, 'false')"

    steps:
      - name: View the github context
        run: echo "$GITHUB_CONTEXT"
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}

      - name: View the information
        run: |
          echo "commit ${{ github.event.after }}"
          echo "actor ${{ github.actor }}"
          echo "The username of the pusher: ${{ github.event.head_commit.author.username }}"
          echo "The name of the pusher: ${{ github.event.head_commit.author.name }}"
          echo "The email of the pusher: ${{ github.event.head_commit.author.email }}"

      - name: Set short_ref env var
        run: |
          SHORT_REF="${{ github.event.ref }}"
          echo "short_ref=${SHORT_REF/refs\/heads\//}" >> $GITHUB_ENV

      - name: checkout develop branch
        uses: actions/checkout@v2
        with:
          ref: 'develop'

      - name: merge the release branch commit
        run: |
          git fetch --unshallow origin develop "${{ github.event.ref }}"
          git config user.name "${{ github.event.head_commit.author.name }}"
          git config user.email "${{ github.event.head_commit.author.email }}"
          set -x
          set +e
          if git merge "origin/${{ env.short_ref }}" &&
            git push origin develop ; then
            echo "merge_failed=" >> $GITHUB_ENV
          else
            echo "merge_failed=true" >> $GITHUB_ENV
          fi

      - name: create new branch
        if: ${{ env.merge_failed == 'true' }}
        uses: peterjgrainger/action-create-branch@v2.0.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          branch: 'merge-release-${{ github.event.after }}'

      - name: Create Pull Request
        if: ${{ env.merge_failed == 'true' }}
        uses: peter-evans/create-pull-request@v3
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          branch: 'merge-release-${{ github.event.after }}'
          title: 'Merge ${{ env.short_ref }}'
          body: 'Merge ${{ env.short_ref }} into develop'
          reviewers: |
            ${{ github.event.head_commit.author.username }}
          team-reviewers: |
            Appboy/application-infrastructure
