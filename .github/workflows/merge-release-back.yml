# When a new push happens to a release-N branch,
# create a pull request merging the latest commit back to the `develop` branch.

---

on:
  push:
    branches: ['release-[0-9]+']

jobs:
  build:
    runs-on: ubuntu-latest
    # this job should only run for things added after the branch is initially created
    if: "contains(github.event.created, 'false')"

    steps:
      - name: Set short_ref env var
        run: |
          SHORT_REF="${{ github.event.ref }}"
          echo "short_ref=${SHORT_REF/refs\/heads\//}" >> $GITHUB_ENV

      - name: checkout develop branch
        uses: actions/checkout@v2
        with:
          ref: 'develop'

      - name: merge the release branch commit
        run: |
          git fetch --unshallow origin develop "${{ github.event.ref }}"
          git config user.name "${{ github.event.head_commit.author.name }}"
          git config user.email "${{ github.event.head_commit.author.email }}"

          set +e
          if git merge "origin/${{ env.short_ref }}" && git push origin develop ; then
            echo "merge_failed=" >> $GITHUB_ENV
          else
            git reset --hard
            echo "merge_failed=true" >> $GITHUB_ENV
          fi

      - name: checkout ref
        if: ${{ env.merge_failed == 'true' }}
        uses: actions/checkout@v2

      - name: create new branch
        if: ${{ env.merge_failed == 'true' }}
        uses: peterjgrainger/action-create-branch@v2.0.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          branch: 'merge-release-${{ github.event.after }}'

      - name: checkout new branch
        if: ${{ env.merge_failed == 'true' }}
        uses: actions/checkout@v2
        with:
          ref: 'merge-release-${{ github.event.after }}'

      - name: Create Pull Request
        if: ${{ env.merge_failed == 'true' }}
        uses: repo-sync/pull-request@v2
        with:
          destination_branch: develop
          source_branch: 'merge-release-${{ github.event.after }}'
          pr_title: 'Merge ${{ env.short_ref }}'
          pr_body: 'Merge ${{ env.short_ref }} into develop'
          pr_reviewer: '${{ github.event.head_commit.author.username }},Appboy/application-infrastructure'
          github_token: ${{ secrets.GITHUB_TOKEN }}
